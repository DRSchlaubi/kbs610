apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: traefik
spec:
  url: https://traefik.github.io/charts
  interval: 24h
---
kind: HelmChart
apiVersion: source.toolkit.fluxcd.io/v1
metadata:
  name: traefik
spec:
  chart: traefik
  interval: 1h
  sourceRef:
    kind: HelmRepository
    name: traefik
  version: "38.x"
---
kind: HelmRelease
apiVersion: helm.toolkit.fluxcd.io/v2
metadata:
  name: traefik
spec:
  interval: 12h
  install:
    strategy:
      name: RetryOnFailure
      retryInterval: 2m
  upgrade:
    strategy:
      name: RetryOnFailure
      retryInterval: 3m
  chartRef:
    kind: HelmChart
    name: traefik
  values:
    providers:
      kubernetesGateway:
        enabled: true
    additionalArguments:
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.priority=1
    gatewayClass:
      enabled: true
    gateway:
      enabled: false # gateway is deployed by ./gateway.yaml
    logs:
      general:
        level: DEBUG
      access:
        enabled: true
    api:
      dashboard: true
    ingressRoute:
      dashboard:
        enabled: true
    deployment:
      kind: DaemonSet
    service:
      type: LoadBalancer
      annotations:
        loadbalancer.openstack.org/proxy-protocol: "true"
    experimental:
      plugins:
        cloudflare:
          moduleName: github.com/agence-gaya/traefik-plugin-cloudflare
          version: v1.0.0
    ports:
      web:
        port: 80
        proxyProtocol:
          enabled: true
          trustedIPs: [ "192.168.2.0/24" ]
      websecure:
        port: 443
        http3:
          # LB does not support HTTP/3 yet anyw
          enabled: false
        proxyProtocol:
          enabled: true
          trustedIPs: [ "192.168.2.0/24" ]
